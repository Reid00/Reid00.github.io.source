---
title: "MIT6.824 2022 Raft Lab2C Log Compaction"
date: 2023-02-09T17:48:58+08:00
lastmod: 2023-02-09T17:48:58+08:00
author: ["Reid"]
categories: 
- Storage
- Raft
tags: 
- Raft
- MIT6.824
- Consensus
- 共识算法
keyword:
- Storage
- Raft
- MIT6.824
- Consensus
- 共识算法
description: ""
weight: # 输入1可以顶置文章，用来给文章展示排序，不填就默认按时间排序
slug: MIT6.824-2022-Raft-Lab2C-Log-Compaction
draft: false # 是否为草稿
comments: true
showToc: true # 显示目录
TocOpen: false # 自动展开目录
hidemeta: false # 是否隐藏文章的元信息，如发布日期、作者等
disableShare: true # 底部不显示分享栏
showbreadcrumbs: true #顶部显示当前路径
cover:
    image: ""
    caption: ""
    alt: ""
    relative: false
---

## 介绍
对Raft Figure2 中需要持久化的字段进行保存。
- 完成persist()和readPersist()函数，编码方式参照注释
- 优化nextIndex[]回退方式，否则无法通过所有测试

提示: 
- 需要持久化的部分包括currentTerm、votedFor、log。
- 有关nextIndex[]回退优化可以查看 [论文简单介绍](20230209-MIT6.824-2022-Raft-介绍.md)

## 持久化
```go
func (rf *Raft) persist() {
	// Your code here (2C).
	// Example:
	// w := new(bytes.Buffer)
	// e := labgob.NewEncoder(w)
	// e.Encode(rf.xxx)
	// e.Encode(rf.yyy)
	// data := w.Bytes()
	// rf.persister.SaveRaftState(data)
	rf.persister.SaveRaftState(rf.encodeState())
}

func (rf *Raft) encodeState() []byte {
	buf := new(bytes.Buffer)
	enc := labgob.NewEncoder(buf)
	// figure2 Persistent state on all servers
	enc.Encode(rf.currentTerm)
	enc.Encode(rf.votedFor)
	enc.Encode(rf.logs)
	return buf.Bytes()
}

// restore previously persisted state.
func (rf *Raft) readPersist(data []byte) {
	if len(data) < 1 {
		return
	}

	buf := bytes.NewBuffer(data)
	dec := labgob.NewDecoder(buf)

	var currentTerm, votedFor int
	var logs []Entry

	if dec.Decode(&currentTerm) != nil || dec.Decode(&votedFor) != nil ||
		dec.Decode(&logs) != nil {
		DPrintf("[readPersist] - {Node: %v} restore persisted data failed", rf.me)
	}

	rf.currentTerm, rf.votedFor, rf.logs = currentTerm, votedFor, logs

	rf.lastApplied, rf.commitIndex = rf.logs[0].Index, rf.logs[0].Index
	// Your code here (2C).
	// Example:
	// r := bytes.NewBuffer(data)
	// d := labgob.NewDecoder(r)
	// var xxx
	// var yyy
	// if d.Decode(&xxx) != nil ||
	//    d.Decode(&yyy) != nil {
	//   error...
	// } else {
	//   rf.xxx = xxx
	//   rf.yyy = yyy
	// }
}
```

## nextIndex 优化
Lab 2B 中对于失败的AppendEntries请求，让nextIndex自减，这样效率是比较慢的。方法上可以以Term 为单位返回，不在一个一个Index 自检。
这需要添加 `ConflicTerm`, `ConflictIndex` 字段 去记录出现冲突的位置和任期。然后在 HanleAppendEntries RPC 中，在 Leader 的log
中检查 `ConflictIndex` 位置的日志一致性。


